{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ruby%20Grace/Downloads/COLLEGE%20OF%20INFORMATION%20TECHNOLOGY2/college_of_information_technology2/lib/db.ts"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nconst pool = mysql.createPool({\r\n  host: process.env.DB_HOST || 'localhost',\r\n  user: process.env.DB_USER || 'root',\r\n  password: process.env.DB_PASSWORD || '',\r\n  database: process.env.DB_NAME || 'cite_es',\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0,\r\n});\r\n\r\nexport async function query(sql: string, values?: any[]) {\r\n  const connection = await pool.getConnection();\r\n  try {\r\n    const [results] = await connection.execute(sql, values);\r\n    return results;\r\n  } finally {\r\n    connection.release();\r\n  }\r\n}\r\n\r\nexport async function queryOne(sql: string, values?: any[]) {\r\n  const results = await query(sql, values);\r\n  return Array.isArray(results) && results.length > 0 ? results[0] : null;\r\n}\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM,OAAO,oLAAK,CAAC,UAAU,CAAC;IAC5B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO,IAAI;IAC7B,UAAU,QAAQ,GAAG,CAAC,WAAW,IAAI;IACrC,UAAU,QAAQ,GAAG,CAAC,OAAO,IAAI;IACjC,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;AACd;AAEO,eAAe,MAAM,GAAW,EAAE,MAAc;IACrD,MAAM,aAAa,MAAM,KAAK,aAAa;IAC3C,IAAI;QACF,MAAM,CAAC,QAAQ,GAAG,MAAM,WAAW,OAAO,CAAC,KAAK;QAChD,OAAO;IACT,SAAU;QACR,WAAW,OAAO;IACpB;AACF;AAEO,eAAe,SAAS,GAAW,EAAE,MAAc;IACxD,MAAM,UAAU,MAAM,MAAM,KAAK;IACjC,OAAO,MAAM,OAAO,CAAC,YAAY,QAAQ,MAAM,GAAG,IAAI,OAAO,CAAC,EAAE,GAAG;AACrE;uCAEe"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ruby%20Grace/Downloads/COLLEGE%20OF%20INFORMATION%20TECHNOLOGY2/college_of_information_technology2/app/api/evaluations/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\ntype EvalRequest = {\r\n  evaluationId?: string;\r\n  responses?: Array<{ criterionId: string; score: number }>;\r\n};\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body: EvalRequest = await request.json();\r\n\r\n    if (!body || !body.evaluationId || !Array.isArray(body.responses)) {\r\n      return NextResponse.json({ error: 'Invalid payload' }, { status: 400 });\r\n    }\r\n\r\n    // In demo mode we just log the payload and return success.\r\n    // Replace this with real persistence / validation as needed.\r\n    // eslint-disable-next-line no-console\r\n    console.info('Received evaluation submission:', {\r\n      evaluationId: body.evaluationId,\r\n      responsesCount: body.responses.length,\r\n    });\r\n\r\n    return NextResponse.json({ success: true, message: 'Evaluation recorded' }, { status: 200 });\r\n  } catch (err) {\r\n    // eslint-disable-next-line no-console\r\n    console.error('Error processing evaluation submission', err);\r\n    return NextResponse.json({ error: 'Server error' }, { status: 500 });\r\n  }\r\n}\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { query, queryOne } from '@/lib/db';\r\n\r\nlet jwt: any = null;\r\n\r\nasync function loadJWT() {\r\n  if (!jwt) {\r\n    const jwtModule = await import('jsonwebtoken');\r\n    jwt = jwtModule.default || jwtModule;\r\n  }\r\n  return jwt;\r\n}\r\n\r\nfunction getAuthToken(request: NextRequest): string | null {\r\n  const authHeader = request.headers.get('authorization');\r\n  if (!authHeader?.startsWith('Bearer ')) {\r\n    return null;\r\n  }\r\n  return authHeader.substring(7);\r\n}\r\n\r\nasync function verifyToken(token: string) {\r\n  try {\r\n    const jwtLib = await loadJWT();\r\n    const decoded = jwtLib.verify(token, process.env.JWT_SECRET || 'secret');\r\n    return decoded;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const token = getAuthToken(request);\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const decoded: any = await verifyToken(token);\r\n    if (!decoded) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid token' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    // Get evaluations for the user\r\n    const evaluations: any = await query(\r\n      `SELECT e.id, e.course_id, e.status, e.created_at, e.due_date,\r\n              c.course_name, c.course_code,\r\n              u.first_name, u.last_name,\r\n              COUNT(DISTINCT er.id) as responses_submitted,\r\n              COUNT(DISTINCT ec.id) as total_criteria\r\n       FROM evaluations e\r\n       INNER JOIN courses c ON e.course_id = c.id\r\n       LEFT JOIN users u ON c.teacher_id = u.id\r\n       LEFT JOIN evaluation_responses er ON e.id = er.evaluation_id\r\n       LEFT JOIN evaluation_criteria ec ON e.id = ec.id\r\n       WHERE e.user_id = ?\r\n       GROUP BY e.id\r\n       ORDER BY e.due_date DESC`,\r\n      [decoded.userId]\r\n    );\r\n\r\n    // Format response\r\n    const formattedEvaluations = (evaluations || []).map((e: any) => ({\r\n      id: e.id,\r\n      course_id: e.course_id,\r\n      course_name: e.course_name,\r\n      course_code: e.course_code,\r\n      teacher_name: e.first_name && e.last_name ? `${e.first_name} ${e.last_name}` : 'Unknown',\r\n      status: e.status || 'pending',\r\n      created_at: e.created_at,\r\n      due_date: e.due_date,\r\n      responses_submitted: e.responses_submitted,\r\n      total_criteria: e.total_criteria,\r\n    }));\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      evaluations: formattedEvaluations,\r\n      total: formattedEvaluations.length,\r\n    });\r\n  } catch (error) {\r\n    console.error('Get evaluations error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error', details: String(error) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = getAuthToken(request);\r\n    if (!token) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const decoded: any = await verifyToken(token);\r\n    if (!decoded) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid token' },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const body = await request.json();\r\n    const { evaluationId, responses } = body;\r\n\r\n    if (!evaluationId || !responses) {\r\n      return NextResponse.json(\r\n        { error: 'Missing required fields' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Verify evaluation exists and belongs to user\r\n    const evaluation: any = await queryOne(\r\n      'SELECT id FROM evaluations WHERE id = ? AND user_id = ?',\r\n      [evaluationId, decoded.userId]\r\n    );\r\n\r\n    if (!evaluation) {\r\n      return NextResponse.json(\r\n        { error: 'Evaluation not found or not assigned to user' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Store evaluation responses\r\n    for (const response of responses) {\r\n      if (response.criterion_id && response.score !== undefined) {\r\n        await query(\r\n          'INSERT INTO evaluation_responses (evaluation_id, criterion_id, score) VALUES (?, ?, ?)',\r\n          [evaluationId, response.criterion_id, response.score]\r\n        );\r\n      }\r\n    }\r\n\r\n    // Update evaluation status to completed\r\n    await query(\r\n      'UPDATE evaluations SET status = ?, updated_at = NOW() WHERE id = ?',\r\n      ['completed', evaluationId]\r\n    );\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Evaluation submitted successfully',\r\n      evaluationId,\r\n    });\r\n  } catch (error) {\r\n    console.error('Submit evaluation error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error', details: String(error) },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}